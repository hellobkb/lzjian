<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>审批</title>
		 
		<tc_include file="App:header" />

		<!--选择器样式-->
		<link rel="stylesheet" type="text/css" href="__TMPL__App/css/mui.picker.min.css" />
		 
		<link rel="stylesheet" type="text/css" href="__TMPL__App/css/approval.css" />
		<style>
			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}

			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}

			.mui-pull-bottom-tips {
				text-align: center;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
		</style>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<button class="mui-action-back mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
				<span class="mui-icon mui-icon-left-nav"></span>
				返回
			</button>
			<h1 class="mui-title">审批</h1>
			<button class="mui-btn mui-btn-blue mui-btn-link mui-pull-right" id="reanod_filtrate">筛选</button>
		</header>
		<div id="content" class="mui-content">
			<div id="slider" class="mui-slider  mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item <if condition='$tab eq 1'> mui-active </if>"  href="#item1mobile">
						报价审批
					</a>
					<a class="mui-control-item <if condition='$tab eq 2'> mui-active </if>"   href="#item2mobile">
						阶段审批
					</a>
					<a class="mui-control-item <if condition='$tab eq 3'> mui-active </if>"  href="#item3mobile">
						沟通关注审批
					</a>
				</div>
				<div class="mui-slider-group">

					<!--报价审批模块-->
					<div id="item1mobile" class="mui-slider-item mui-control-content <if condition='$tab eq 1'> mui-active </if>">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<li class="mui-table-view-cell mui-collapse">
										<!--<a class="mui-navigate-right" href="#">筛选</a>-->
										<div class="mui-collapse-content">
											<div class="reanod-head">
												<div>
													<b>选择日期</b>
													<div>
														<button class="date_select startDate">开始时间</button>
														<span>&nbsp;&nbsp;&nbsp;</span>
														<button class="date_select endDate">结束时间</button>
													</div>
												</div>
												<div>
													<b>业务员</b>
													<input type="text" class="select_salesman" readOnly="true" value="全部">
												</div>
												<div>
													<b>审批状态</b>
													<input type="text" value="全部" data-val="3" class="select_state" id="baojia_state">
												</div>
												<div>
													<b>客户名称</b>
													<input class="mui-input-clear customer_name" type="text" placeholder="请输入客户名称" />
												</div>
											</div>
											<div class="reanod-submit">
												<button class="mui-btn-yellow reanod_confirm">确定</button>
												<button class="mui-btn-grey reanod_cancel">取消</button></div>
										</div>
									</li>
								</ul>
								<div class="mui-loading">
									<div class="mui-spinner">
									</div>
								</div>
								<!--数据-->
								<div class="reanod-data">
								</div>
							</div>
						</div>
					</div>

					<!--阶段审批模块-->
					<div id="item2mobile" class="mui-slider-item mui-control-content <if condition='$tab eq 2'> mui-active </if>">
						<div id="scroll2" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view" style="display: none;">
									<li class="mui-table-view-cell mui-collapse">
										<!--<a class="mui-navigate-right" href="#">筛选</a>-->
										<div class="mui-collapse-content">
											<div class="reanod-head">
												<div>
													<b>选择日期</b>
													<div>
														<button class="date_select startDate">开始时间</button>
														<span>&nbsp;&nbsp;&nbsp;</span>
														<button class="date_select endDate">结束时间</button>
													</div>
												</div>
												<div>
													<b>业务员</b>
													<input type="text" class="select_salesman" value="全部">

												</div>
												<div>
													<b>阶段</b>
													<input type="text" value="全部" class="select_state" id="jieduan">
												</div>
											</div>
											<div class="reanod-submit">
												<button class="mui-btn-yellow reanod_confirm">确定</button>
												<button class="mui-btn-grey reanod_cancel">取消</button></div>
										</div>
									</li>
								</ul>
								<div class="mui-loading">
									<div class="mui-spinner">
									</div>
								</div>
								<!--数据-->
								<div class="reanod-data">
								</div>
							</div>
						</div>
					</div>

					<!--沟通关注审批模块-->
					<div id="item3mobile" class="mui-slider-item mui-control-content <if condition='$tab eq 3'> mui-active </if>">
						<div id="scroll3" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view" style="display: none;">
									<li class="mui-table-view-cell mui-collapse">
										<!--<a class="mui-navigate-right" href="#">筛选</a>-->
										<div class="mui-collapse-content">
											<div class="reanod-head">
												<div>
													<b>选择日期</b>
													<div>
														<button class="date_select startDate">开始时间</button>
														<span>&nbsp;&nbsp;&nbsp;</span>
														<button class="date_select endDate">结束时间</button>
													</div>
												</div>
												<div>
													<b>业务员</b>
													<input type="text" class="select_salesman" value="全部">
												</div>
												<div>
													<b>审批状态</b>
													<input type="text" value="全部" data-val="2" class="select_state" id="goutong_state">
												</div>
												<div>
													<b>客户名称</b>
													<input class="mui-input-clear customer_name" type="text" placeholder="请输入客户名称" />
												</div>
											</div>
											<div class="reanod-submit">
												<button class="mui-btn-yellow reanod_confirm">确定</button>
												<button class="mui-btn-grey reanod_cancel">取消</button></div>
										</div>
									</li>
								</ul>
								<div class="mui-loading">
									<div class="mui-spinner">
									</div>
								</div>
								<!--数据-->
								<div class="reanod-data">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			 
			<tc_include file="App:footer" />

		</div>
		 
		<!--选择器插件-->
		<script type="text/javascript" src="__TMPL__App/js/mui.picker.min.js"></script>
		<!--日期选择-->
		<script type="text/javascript" src="__TMPL__App/js/dateCheck.js"></script>
		<!--上下拉插件-->
		<script src="__TMPL__App/js/mui.pullToRefresh.js"></script>
		<script src="__TMPL__App/js/mui.pullToRefresh.material.js"></script>
		 
	</body>

	<script>
			
mui.init({});
//阻尼系数
var deceleration = mui.os.ios ? 0.003 : 0.0009;
mui('.mui-scroll-wrapper').scroll({
	bounce: false,
	indicators: true, //是否显示滚动条
	deceleration: deceleration
});

//列表点击事件
bandList(mui('.reanod-data')); 

//上拉请求请求地址、请求参数

var requestUrl1 = localStorage.getItem('keyUrl') +'/index.php?g=App&m=Mobile&a=offer_list_pull'; //报价审批上拉请求地址
var requestUrl2 = localStorage.getItem('keyUrl') +'/index.php?g=App&m=Mobile&a=client_list_pull'; //阶段审批上拉请求地址
var requestUrl3 = localStorage.getItem('keyUrl') +'/index.php?g=App&m=Mobile&a=contact_list_pull'; //沟通关注审批上拉请求地址

var pageCount1 = 1; //报价审批上拉请求页数
var pageCount2 = 1; //阶段审批上拉请求页数
var pageCount3 = 1; //沟通关注审批上拉请求页数

var listrow =3 ;

var token = "{$token}";

var requestPost1 = {};
requestPost1.token = token;
requestPost1.listrow = listrow;
/*requestPost1.roleid = localStorage.getItem('role');
requestPost1.uid = localStorage.getItem('uid');*/


var requestPost2 = {};
requestPost2.token = token;
requestPost2.listrow = listrow;
/*requestPost2.roleid = localStorage.getItem('role');
requestPost2.uid = localStorage.getItem('uid');*/


var requestPost3 = {};
requestPost3.token = token;
requestPost3.listrow = listrow;
/*requestPost3.roleid = localStorage.getItem('role');
requestPost3.uid = localStorage.getItem('uid');*/


mui.ready(function() {
	//初始化业务员和审批状态
		//业务员
		var yewuyuanPicker = new mui.PopPicker();
		yewuyuanPicker.setData({$sale_list});

		mui.each(document.querySelectorAll('.select_salesman'), function(index,el) {
			el.addEventListener('tap', function(event) {
			yewuyuanPicker.show(function(items) {
				el.value = items[0].text;
				el.setAttribute("data-val" ,items[0].value);
				//返回 false 可以阻止选择框的关闭
				//return false;
				});
			}, false);
		});
		
		//审批状态（报价审批）
		var shenpizhuangtaiPicker = new mui.PopPicker();
		shenpizhuangtaiPicker.setData({$bj_status});
		var shenpizhuangtaiInput = document.getElementById('baojia_state');
		shenpizhuangtaiInput.addEventListener('tap', function(event) {
				shenpizhuangtaiPicker.show(function(items) {
					shenpizhuangtaiInput.value = items[0].text;
					shenpizhuangtaiInput.setAttribute("data-val" ,items[0].value);
					
					//返回 false 可以阻止选择框的关闭
					//return false;
				});
			}, false);
		
		//审批状态（沟通关注审批）
		var shenpizhuangtai1Picker = new mui.PopPicker();
		shenpizhuangtai1Picker.setData({$sp_status});
		var shenpizhuangtai1Input = document.getElementById('goutong_state')
		shenpizhuangtai1Input.addEventListener('tap', function(event) {
				shenpizhuangtai1Picker.show(function(items) {
					shenpizhuangtai1Input.value = items[0].text;
					shenpizhuangtai1Input.setAttribute("data-val" ,items[0].value);
					
					//返回 false 可以阻止选择框的关闭
					//return false;
				});
			}, false);
		
		//阶段
		var jieduanPicker = new mui.PopPicker();
		jieduanPicker.setData({$level});
		mui.each(document.querySelectorAll('#jieduan'), function(index,el) {
			el.addEventListener('tap', function(event) {
			jieduanPicker.show(function(items) {
				el.value = items[0].text;
				el.setAttribute("data-val" ,items[0].value);
				//返回 false 可以阻止选择框的关闭
				//return false;
				});
			}, false);
		});
 
	 
});

mui.ready(function() {
	//循环初始化所有下拉刷新，上拉加载。
	mui.each(document.querySelectorAll('#slider .mui-scroll'), function(index,pullRefreshEl) {	
		
		var out_self;
		
		mui(pullRefreshEl).pullToRefresh({
			down: {
				callback: function() {
					out_self = this;
					setTimeout(function() {
						downScreen(index,out_self,pullRefreshEl);
						
						out_self.endPullDownToRefresh();
						
						//mui.toast("test - down"+index);
					}, 1000);
				}
			},
			up: {
				auto: true, //自动上拉加载一次
				callback: function() {
					out_self = this;
					setTimeout(function() {
						upScreen(index,out_self);
						
						//mui.toast("test - up"+index);
					}, 1000);
				}
			}
		});
		
		var item = this;
		
		var submitbtn = item.querySelector(".reanod_confirm");
		var cancelBtn = item.querySelector(".reanod_cancel")
		var screenData = item.querySelector('.reanod-data'); //上拉数据
		var fold = item.querySelector(".mui-table-view-cell");
	
		//确认按钮
		submitbtn.addEventListener('tap', function() {
			fold.classList.remove("mui-active"); //收起折叠
			screenData.innerHTML = ''; //清空数据
	
			//获取所有值
			var startDate = item.querySelector('.startDate').value; //开始时间
			var endDate = item.querySelector('.endDate').value; //结束时间
			var selectSalesman = item.querySelector('.select_salesman').getAttribute("data-val"); //业务员
			var selectState = item.querySelector('.select_state').getAttribute("data-val"); //状态

			if(index !=1){
				var customerName = item.querySelector('.customer_name').value; //客户名称
				customerName && customerName.value;
			}
			
			//更改请求地址或请求参数
			if(index == 0) {
				requestPost1.stime = startDate;
				requestPost1.etime = endDate;
				requestPost1.reqstatus = selectState;
				requestPost1.cname = customerName;
				requestPost1.sale = selectSalesman;
	
				pageCount1 = 1; // 重置刷新次数
			} else if(index == 1) {
				requestPost2.stime = startDate;
				requestPost2.etime = endDate;
				requestPost2.level = selectState;
				requestPost2.sale = selectSalesman;
	
				pageCount2 = 1;// 重置刷新次数
			} else if(index == 2) {
				requestPost3.stime = startDate;
				requestPost3.etime = endDate;
				requestPost3.reqstatus = selectState;
				requestPost3.cname = customerName;
				requestPost3.sale = selectSalesman;
	
				pageCount3 = 1; // 重置刷新次数
			}
			
			upScreen(index,out_self);
		});
		
		//取消按钮
		cancelBtn.addEventListener('tap', function() {
			fold.classList.remove("mui-active"); //收起折叠
		});
	});
});

//下拉加载
function downScreen(index,self,pullRefreshEl){
	self.element.querySelector('.reanod-data').innerHTML = '';
	mui(pullRefreshEl).pullToRefresh().refresh(true);
	
	if(index == 0) {
		pageCount1 = 1;
		upScreen(index,self);
	} else if(index == 1) {
		pageCount2 = 1;
		upScreen(index,self);
	} else if(index == 2) {
		pageCount3 = 1;
		upScreen(index,self);
	}
}

//上拉加载
var upScreen = function(index, self) {
	var requestUrl, requestPost;
	
	if(index == 0) {
		var scroll = document.getElementById('scroll1');
		requestUrl = requestUrl1;
		requestPost = requestPost1;
		requestPost.page = pageCount1;
		
		//获取数据

		mui.ajax(requestUrl , {
			data:requestPost,
			dataType :'json',
			type :'post',
			timeout:10000,
			success:function(str){
				if(str.status == 1){
					data = str.info;
					pageCount1++ ; 

					if(data.length <listrow){
						self.endPullUpToRefresh(true); 
					}else {
						self.endPullUpToRefresh(false);
					}
					
					var muiLoading = scroll.querySelector('.mui-loading');
					if(muiLoading) muiLoading.innerHTML = '';
					//显示筛选
					scroll.firstElementChild.style.display = "";

					//添加数据
					addData(data, self, index+1);
				}else if (str.status == 0 ){
					self.endPullUpToRefresh(true); //参数为true表示没有更多数据了。
					return;
				}

			},
			error:function(xhr ,type, errorThrown){
				mui.toast("获取数据失败");
			}
		});

	} else if(index == 1) {
		var scroll = document.getElementById('scroll2').firstElementChild;
		requestUrl = requestUrl2;
		requestPost = requestPost2;
		requestPost.page = pageCount2;
		

		mui.ajax(requestUrl , {
			data:requestPost,
			dataType :'json',
			type :'post',
			timeout:10000,
			success:function(str){
				if(str.status == 1){
					data = str.info;
					pageCount2++ ; 
					if(data.length <3){
						self.endPullUpToRefresh(true); 
					}else {
						self.endPullUpToRefresh(false);
					}
					
					var muiLoading = scroll.querySelector('.mui-loading');
					if(muiLoading) muiLoading.innerHTML = '';
					//显示筛选
					scroll.firstElementChild.style.display = "";

					//添加数据
					addData(data, self, index+1);
				}else if (str.status == 0 ){
					self.endPullUpToRefresh(true); //参数为true表示没有更多数据了。
					return;
				}
			},
			error:function(xhr ,type, errorThrown){
				mui.toast("获取数据失败");
			}

		});

	} else if(index == 2) {
		var scroll = document.getElementById('scroll3').firstElementChild;
		requestUrl = requestUrl3;
		requestPost = requestPost3;
		requestPost.page = pageCount3;

		mui.ajax(requestUrl , {
			data:requestPost,
			dataType :'json',
			type :'post',
			timeout:10000,
			success:function(str){
				if(str.status == 1 ){
					data = str.info;
					pageCount3 ++;
					if(data.length<3){
						self.endPullUpToRefresh(true); 
					}else {
						self.endPullUpToRefresh(false);
					}
				
					var muiLoading = scroll.querySelector('.mui-loading');
					if(muiLoading) muiLoading.innerHTML = '';
					//显示筛选
					scroll.firstElementChild.style.display = "";
				
					addData(data, self, index+1);
				}else if (str.status == -1 ){
					 
					self.endPullUpToRefresh(true); //参数为true表示没有更多数据了。
					return;
				}

			},
			error:function(xhr ,type, errorThrown){
				mui.toast("获取数据失败");
			}

		});

	}
}

//添加数据
function addData(data, self, num) {
	var table = self.element.querySelector('.reanod-data');
	var div = document.createElement('div');
	var divContent = '';

	for(var i in data) {
		var spanContent = '';

		var company = data[i].company; //公司
		var proposer = data[i].proposer; //申请人
		var applyDate = data[i].applyDate; //申请时间

		//不确定值，如：阶段，有时没有用到
		var isDispose = data[i].isDispose; //0 为未回复、未审批，1为已回复、已审批，其它表示为拒绝
		var attachment = data[i].attachment; //附件，0为没有附件，其它表示有附件
		if(!attachment || attachment == '0' || attachment == 0){
			attachment = '无';
		}else{
			attachment ='有';
		}

		var state = data[i].state; //阶段

		//详情地址
		var linkUrl = data[i].detailUrl;

		//报价审批
		if(num == 1) {
			if(isDispose == 0) {
				spanContent = '' +
					'<span style="color:red;">未审批<span class="mui-icon mui-icon-forward"></span></span>';
			} else if(isDispose == 1) {
				spanContent = '' +
					'<span>已审批<span class="mui-icon mui-icon-forward"></span></span>';
			} else {
				spanContent = '' +
					'<span>已拒绝<span class="mui-icon mui-icon-forward"></span></span>';
			}

			divContent += '' +
				'<div class ="reanod-result">' +
				'<a href ="' + linkUrl + '">' +
				'<div class="result-title-left"><span>' + company + '</span></div>' +
				'<div class="result-title-right">' + spanContent + '</div>' +
				'</a>' +
				'<a href ="' + linkUrl + '">' +
				'<div class="result-content">' + '<div>申请人：<span>' + proposer + '</span></div>' +
				'<div>附件：<span>' + attachment + '</span></div>' +
				'<div>申请时间：<span>' + applyDate + '</span></div>' +
				'</div>' +
				'</a>' +
				'</div>';
		}
		//阶段审批
		else if(num == 2) {
			spanContent = '' +
				'<span style="color:red">审批<span class="mui-icon mui-icon-forward"></span></span>';

			divContent += '' +
				'<div class ="reanod-result">' +
				'<a href ="' + linkUrl + '">' +
				'<div class="result-title-left"><span>' + company + '</span></div>' +
				'<div class="result-title-right">' + spanContent + '</div>' +
				'</a>' +
				'<a href ="' + linkUrl + '">' +
				'<div class="result-content">' + '<div>申请人：<span>' + proposer + '</span></div>' +
				'<div>申请阶段：<span>' + state + '</span></div>' +
				'<div>申请时间：<span>' + applyDate + '</span></div>' +
				'</div>' +
				'</a>' +
				'</div>';
		}
		//沟通关注审批					
		else if(num == 3) {
			if(isDispose == 0) {
				spanContent = '' +
					'<span style="color:red;">未回复<span class="mui-icon mui-icon-forward"></span></span>';
			} else {
				spanContent = '' +
					'<span>已回复<span class="mui-icon mui-icon-forward"></span></span>';
			}

			divContent += '' +
				'<div class ="reanod-result">' +
				'<a href ="' + linkUrl + '">' +
				'<div class="result-title-left"><span>' + company + '</span></div>' +
				'<div class="result-title-right">' + spanContent + '</div>' +
				'</a>' +
				'<a href ="' + linkUrl + '">' +
				'<div class="result-content">' + '<div>申请人：<span>' + proposer + '</span></div>' +
				'<div>所处阶段：<span>' + state + '</span></div>' +
				'<div>申请时间：<span>' + applyDate + '</span></div>' +
				'</div>' +
				'</a>' +
				'</div>';
		}

	}
	div.innerHTML = divContent;
	table.appendChild(div);

	addMaxWidth();
}

//控制公司名称最大宽度
function addMaxWidth() {
	var titleLefts = document.querySelectorAll('.result-title-left');
	for(var i = 0; i < titleLefts.length; i++) {
		var tl = titleLefts[i];
		var maxWidth = tl.nextSibling.offsetWidth + 4;
		tl.style.maxWidth = 'calc(100% - ' + maxWidth + 'px)';
	}
}

//筛选按钮
//默认绑定第一个折叠列表
document.getElementById('reanod_filtrate').addEventListener('tap', function() {
	//遍历筛选
	mui('.mui-slider-item').each(function() {
		if(this.classList.contains('mui-active')) {
			this.querySelector(".mui-table-view-cell").classList.add('mui-active');
		}
	});
});

</script>


</html>